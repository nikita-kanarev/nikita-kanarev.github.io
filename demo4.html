<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Universal Font Demo</title>
  <style>
    body { 
      font-family: monospace; 
      margin: 20px; 
      line-height: 1.4;
    }
    
    .section { 
      margin-bottom: 40px; 
    }
    
    .font-tester {
      width: 100%;
      min-height: 60px;
      padding: 10px;
      border: 1px solid #ccc;
      font-size: 24px;
      outline: none;
    }
    
    .controls {
      margin: 10px 0;
    }
    
    .control {
      margin: 5px 0;
    }
    
    label {
      display: inline-block;
      width: 80px;
      font-size: 12px;
    }
    
    input[type="range"] {
      width: 200px;
    }
    
    input[type="checkbox"] {
      margin-right: 5px;
    }
    
    .value {
      font-size: 12px;
      margin-left: 10px;
    }
    
    h3 {
      margin: 20px 0 10px 0;
      font-size: 14px;
    }
    
    .named-instances {
      margin-top: 20px;
      padding-top: 10px;
      border-top: 1px solid #ccc;
    }
    
    .instance-display {
      margin: 10px 0;
      display: flex;
      align-items: center;
    }
    
    .instance-label {
      width: 120px;
      font-size: 12px;
      flex-shrink: 0;
    }
    
    .instance-sample {
      font-size: 48px;
      margin-left: 10px;
    }

    .error {
      color: red;
      border: 1px solid red;
      padding: 10px;
      margin: 10px 0;
    }

    .loading {
      color: #666;
    }
  </style>
</head>
<body>

  <div id="font-demo"></div>

  <script>
    class FontDemo {
      constructor(fontUrl, metaUrl) {
        this.fontUrl = fontUrl;
        this.metaUrl = metaUrl;
        this.fontFamily = '';
        this.meta = null;
        this.container = document.getElementById('font-demo');
      }

      async init() {
        try {
          this.showLoading();
          
          // Load metadata
          const metaRes = await fetch(this.metaUrl);
          if (!metaRes.ok) throw new Error(`Failed to load metadata: ${metaRes.status}`);
          this.meta = await metaRes.json();
          
          // Load font
          this.fontFamily = this.meta.name || 'CustomFont';
          const font = new FontFace(this.fontFamily, `url(${this.fontUrl})`);
          await font.load();
          document.fonts.add(font);
          
          // Build UI
          this.buildUI();
          
        } catch (error) {
          this.showError(error.message);
        }
      }

      showLoading() {
        this.container.innerHTML = '<div class="loading">Loading font and metadata...</div>';
      }

      showError(message) {
        this.container.innerHTML = `<div class="error">Error: ${message}</div>`;
      }

      buildUI() {
        this.container.innerHTML = '';
        
        // Name display
        this.createNameDisplay();
        
        // Main sampler
        this.createMainSampler();
        
        // Multi-line tester
        this.createMultiTester();
        
        // Individual instances
        this.createInstanceTesters();
      }

      createNameDisplay() {
        const section = document.createElement('div');
        section.className = 'section';
        
        const title = document.createElement('h3');
        title.textContent = 'Name';
        
        const tester = document.createElement('div');
        tester.className = 'font-tester';
        tester.style.fontSize = '48px';
        tester.textContent = this.meta.name || 'Font Name';
        
        this.applyFontVariation(tester, this.getDefaultAxes());
        
        section.appendChild(title);
        section.appendChild(tester);
        this.container.appendChild(section);
      }

      createMainSampler() {
        const section = document.createElement('div');
        section.className = 'section';
        
        const title = document.createElement('h3');
        title.textContent = 'Main Sampler';
        
        const tester = document.createElement('div');
        tester.className = 'font-tester';
        tester.contentEditable = true;
        tester.style.fontSize = '80px';
        tester.textContent = 'Type here';
        
        const controls = this.createControls('main');
        const instances = this.createNamedInstancesDisplay();
        
        section.appendChild(title);
        section.appendChild(tester);
        section.appendChild(controls);
        section.appendChild(instances);
        
        this.container.appendChild(section);
        
        // Setup event handlers
        this.setupControlHandlers('main', tester, instances.querySelectorAll('.instance-sample'));
        
        // Sync text between main tester and instances
        tester.addEventListener('input', () => {
          const text = tester.textContent;
          instances.querySelectorAll('.instance-sample').forEach(sample => {
            sample.textContent = text;
          });
        });
      }

      createMultiTester() {
        const section = document.createElement('div');
        section.className = 'section';
        
        const title = document.createElement('h3');
        title.textContent = 'Multi-line Tester';
        
        const tester = document.createElement('div');
        tester.className = 'font-tester';
        tester.contentEditable = true;
        tester.style.fontSize = '24px';
        tester.textContent = 'Multi-line text here';
        
        const controls = this.createControls('multi', true);
        
        section.appendChild(title);
        section.appendChild(tester);
        section.appendChild(controls);
        
        this.container.appendChild(section);
        
        this.setupControlHandlers('multi', tester);
      }

      createInstanceTesters() {
        if (!this.meta.instances || !this.meta.instances.length) return;
        
        const section = document.createElement('div');
        section.className = 'section';
        
        const title = document.createElement('h3');
        title.textContent = 'Individual Instances';
        
        section.appendChild(title);
        
        this.meta.instances.forEach(instance => {
          const instanceSection = document.createElement('div');
          
          const instanceTitle = document.createElement('h3');
          instanceTitle.textContent = instance.name;
          
          const tester = document.createElement('div');
          tester.className = 'font-tester';
          tester.contentEditable = true;
          tester.style.fontSize = '32px';
          tester.textContent = instance.name;
          
          this.applyFontVariation(tester, instance.instance || {});
          
          instanceSection.appendChild(instanceTitle);
          instanceSection.appendChild(tester);
          section.appendChild(instanceSection);
        });
        
        this.container.appendChild(section);
      }

      createControls(prefix, includeSize = false) {
        const controls = document.createElement('div');
        controls.className = 'controls';
        
        // Size control
        if (includeSize) {
          const sizeControl = document.createElement('div');
          sizeControl.className = 'control';
          
          const sizeLabel = document.createElement('label');
          sizeLabel.textContent = 'Size:';
          
          const sizeRange = document.createElement('input');
          sizeRange.type = 'range';
          sizeRange.min = '12';
          sizeRange.max = '120';
          sizeRange.value = '24';
          sizeRange.id = `${prefix}_size`;
          
          const sizeValue = document.createElement('span');
          sizeValue.className = 'value';
          sizeValue.textContent = '24px';
          sizeValue.id = `${prefix}_size_value`;
          
          sizeControl.appendChild(sizeLabel);
          sizeControl.appendChild(sizeRange);
          sizeControl.appendChild(sizeValue);
          controls.appendChild(sizeControl);
        }
        
        // Axes controls
        if (this.meta.axes && this.meta.axes.length) {
          this.meta.axes.forEach(axis => {
            const axisControl = document.createElement('div');
            axisControl.className = 'control';
            
            const label = document.createElement('label');
            label.textContent = `${axis.label || axis.tag}:`;
            
            const range = document.createElement('input');
            range.type = 'range';
            range.min = axis.min;
            range.max = axis.max;
            range.step = axis.step || 1;
            range.value = axis.default;
            range.id = `${prefix}_${axis.tag}`;
            
            const value = document.createElement('span');
            value.className = 'value';
            value.textContent = axis.default;
            value.id = `${prefix}_${axis.tag}_value`;
            
            axisControl.appendChild(label);
            axisControl.appendChild(range);
            axisControl.appendChild(value);
            controls.appendChild(axisControl);
          });
        }
        
        // Features controls
        if (this.meta.features && this.meta.features.length) {
          const featuresControl = document.createElement('div');
          featuresControl.className = 'control';
          
          this.meta.features.forEach(feature => {
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `${prefix}_${feature}`;
            if (feature === 'liga') checkbox.checked = true;
            
            const label = document.createElement('label');
            label.setAttribute('for', `${prefix}_${feature}`);
            label.textContent = feature;
            
            featuresControl.appendChild(checkbox);
            featuresControl.appendChild(label);
          });
          
          controls.appendChild(featuresControl);
        }
        
        return controls;
      }

      createNamedInstancesDisplay() {
        const container = document.createElement('div');
        container.className = 'named-instances';
        
        if (!this.meta.instances || !this.meta.instances.length) return container;
        
        this.meta.instances.forEach(instance => {
          const display = document.createElement('div');
          display.className = 'instance-display';
          
          const label = document.createElement('span');
          label.className = 'instance-label';
          label.textContent = `${instance.name}:`;
          
          const sample = document.createElement('span');
          sample.className = 'instance-sample';
          sample.textContent = 'Type here';
          
          // Store instance data
          sample.dataset.instance = JSON.stringify(instance.instance || {});
          
          this.applyFontVariation(sample, instance.instance || {});
          
          display.appendChild(label);
          display.appendChild(sample);
          container.appendChild(display);
        });
        
        return container;
      }

      setupControlHandlers(prefix, tester, instanceSamples = []) {
        const updateFont = () => {
          const axes = {};
          const features = {};
          
          // Get size
          const sizeControl = document.getElementById(`${prefix}_size`);
          if (sizeControl) {
            const size = parseInt(sizeControl.value);
            tester.style.fontSize = size + 'px';
            document.getElementById(`${prefix}_size_value`).textContent = size + 'px';
          }
          
          // Get axes values
          if (this.meta.axes) {
            this.meta.axes.forEach(axis => {
              const control = document.getElementById(`${prefix}_${axis.tag}`);
              if (control) {
                axes[axis.tag] = parseInt(control.value);
                document.getElementById(`${prefix}_${axis.tag}_value`).textContent = control.value;
              }
            });
          }
          
          // Get features
          if (this.meta.features) {
            this.meta.features.forEach(feature => {
              const control = document.getElementById(`${prefix}_${feature}`);
              if (control) {
                features[feature] = control.checked;
              }
            });
          }
          
          // Apply to main tester
          this.applyFontVariation(tester, axes, features);
          
          // Apply to instance samples (with their own axes but shared features)
          instanceSamples.forEach(sample => {
            const instanceAxes = JSON.parse(sample.dataset.instance || '{}');
            this.applyFontVariation(sample, instanceAxes, features);
          });
        };
        
        // Add event listeners
        const sizeControl = document.getElementById(`${prefix}_size`);
        if (sizeControl) {
          sizeControl.addEventListener('input', updateFont);
        }
        
        if (this.meta.axes) {
          this.meta.axes.forEach(axis => {
            const control = document.getElementById(`${prefix}_${axis.tag}`);
            if (control) {
              control.addEventListener('input', updateFont);
            }
          });
        }
        
        if (this.meta.features) {
          this.meta.features.forEach(feature => {
            const control = document.getElementById(`${prefix}_${feature}`);
            if (control) {
              control.addEventListener('change', updateFont);
            }
          });
        }
        
        // Initial update
        updateFont();
      }

      getDefaultAxes() {
        const defaults = {};
        if (this.meta.axes) {
          this.meta.axes.forEach(axis => {
            defaults[axis.tag] = axis.default;
          });
        }
        return defaults;
      }

      applyFontVariation(element, axes = {}, features = {}) {
        element.style.fontFamily = `${this.fontFamily}, monospace`;
        
        // Apply variable axes
        const axisSettings = Object.entries(axes)
          .map(([tag, value]) => `"${tag}" ${value}`)
          .join(', ');
        
        if (axisSettings) {
          element.style.fontVariationSettings = axisSettings;
        }
        
        // Apply OpenType features
        const featureSettings = Object.entries(features)
          .filter(([key, value]) => value)
          .map(([key]) => `"${key}"`)
          .join(', ');
        
        element.style.fontFeatureSettings = featureSettings || 'normal';
      }
    }

    // Initialize with Archaism font (can be easily changed)
    document.addEventListener('DOMContentLoaded', () => {
      const demo = new FontDemo(
        'https://nikita-kanarev.github.io/Archaism.woff2',
        'https://nikita-kanarev.github.io/Archaism.json'
      );
      demo.init();
    });
  </script>

</body>
</html>